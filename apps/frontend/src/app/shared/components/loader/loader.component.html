<!-- Loader Component Template -->
<div 
  class="loader-overlay" 
  [class.fullscreen]="fullscreen"
  [class.inline]="!fullscreen"
  [class.backdrop-blur]="backdropBlur"
  [@fadeIn]="animationState"
  [attr.role]="'status'"
  [attr.aria-live]="'polite'"
  [attr.aria-busy]="'true'"
  [attr.aria-label]="ariaLabel || (message ? message : ('loader.loading' | translate))"
>
  <div 
    class="loader-container"
    [class.loader-small]="size === 'small'"
    [class.loader-medium]="size === 'medium'"
    [class.loader-large]="size === 'large'"
  >
    <!-- Circular Spinner -->
    <div class="loader-spinner" *ngIf="type === 'circular'">
      <mat-progress-spinner
        [mode]="mode"
        [value]="progress"
        [diameter]="spinnerDiameter"
        [strokeWidth]="strokeWidth"
        [color]="color"
      ></mat-progress-spinner>
      
      <!-- Progress Percentage -->
      <div class="progress-text" *ngIf="showProgress && mode === 'determinate'">
        {{ progress }}%
      </div>
    </div>

    <!-- Linear Progress Bar -->
    <div class="loader-linear" *ngIf="type === 'linear'">
      <mat-progress-bar
        [mode]="mode"
        [value]="progress"
        [bufferValue]="bufferValue"
        [color]="color"
      ></mat-progress-bar>
      
      <div class="progress-info" *ngIf="showProgress">
        <span class="progress-label">{{ progressLabel | translate }}</span>
        <span class="progress-value">{{ progress }}%</span>
      </div>
    </div>

    <!-- Skeleton Loader -->
    <div class="loader-skeleton" *ngIf="type === 'skeleton'">
      <div class="skeleton-item" *ngFor="let item of skeletonItems; trackBy: trackByIndex">
        <div class="skeleton-avatar" *ngIf="item.avatar"></div>
        <div class="skeleton-content">
          <div class="skeleton-line skeleton-title" *ngIf="item.title"></div>
          <div class="skeleton-line" *ngFor="let line of item.lines; trackBy: trackByIndex"></div>
        </div>
      </div>
    </div>

    <!-- Dots Loader -->
    <div class="loader-dots" *ngIf="type === 'dots'">
      <span class="dot" *ngFor="let dot of [1,2,3,4]; trackBy: trackByIndex"></span>
    </div>

    <!-- Pulse Loader -->
    <div class="loader-pulse" *ngIf="type === 'pulse'">
      <div class="pulse-ring"></div>
      <div class="pulse-ring"></div>
      <div class="pulse-ring"></div>
    </div>

    <!-- Custom Icon Loader -->
    <div class="loader-icon" *ngIf="type === 'icon' && customIcon">
      <mat-icon 
        class="rotating-icon"
        [svgIcon]="customIcon.includes('/') ? customIcon : ''"
      >
        {{ !customIcon.includes('/') ? customIcon : '' }}
      </mat-icon>
    </div>

    <!-- Loading Message -->
    <div 
      class="loader-message" 
      *ngIf="message"
      [class.message-below]="messagePosition === 'below'"
      [class.message-above]="messagePosition === 'above'"
    >
      <span class="message-text">{{ message | translate }}</span>
      
      <!-- Animated Dots for Message -->
      <span class="message-dots" *ngIf="showMessageDots">
        <span class="dot"></span>
        <span class="dot"></span>
        <span class="dot"></span>
      </span>
    </div>

    <!-- Sub-message or Tips -->
    <div class="loader-submessage" *ngIf="submessage">
      <mat-icon class="tip-icon" *ngIf="showTipIcon">lightbulb</mat-icon>
      <span>{{ submessage | translate }}</span>
    </div>

    <!-- Action Buttons (e.g., Cancel) -->
    <div class="loader-actions" *ngIf="showActions">
      <button 
        mat-stroked-button
        color="primary"
        (click)="onCancel()"
        [disabled]="!cancelable"
        *ngIf="showCancelButton"
      >
        {{ 'loader.cancel' | translate }}
      </button>
      
      <button 
        mat-button
        (click)="onRetry()"
        *ngIf="showRetryButton"
      >
        {{ 'loader.retry' | translate }}
      </button>
    </div>

    <!-- Time Elapsed -->
    <div class="loader-timer" *ngIf="showTimer">
      <mat-icon class="timer-icon">schedule</mat-icon>
      <span>{{ elapsedTime | translate: { time: formattedTime } }}</span>
    </div>

    <!-- Steps Progress -->
    <div class="loader-steps" *ngIf="steps && steps.length > 0">
      <div class="steps-container">
        <div 
          class="step"
          *ngFor="let step of steps; let i = index; trackBy: trackByStep"
          [class.completed]="step.completed"
          [class.active]="step.active"
          [class.error]="step.error"
        >
          <div class="step-indicator">
            <mat-icon *ngIf="step.completed && !step.error">check_circle</mat-icon>
            <mat-icon *ngIf="step.error">error</mat-icon>
            <mat-spinner 
              *ngIf="step.active && !step.completed && !step.error"
              [diameter]="20"
              [strokeWidth]="2"
            ></mat-spinner>
            <span class="step-number" *ngIf="!step.completed && !step.active && !step.error">
              {{ i + 1 }}
            </span>
          </div>
          <div class="step-content">
            <div class="step-title">{{ step.title | translate }}</div>
            <div class="step-description" *ngIf="step.description">
              {{ step.description | translate }}
            </div>
          </div>
        </div>
      </div>
      
      <!-- Overall Progress -->
      <div class="steps-progress">
        <mat-progress-bar 
          mode="determinate" 
          [value]="stepsProgress"
          color="primary"
        ></mat-progress-bar>
        <span class="steps-count">
          {{ completedSteps }} / {{ steps.length }} {{ 'loader.stepsCompleted' | translate }}
        </span>
      </div>
    </div>
  </div>

  <!-- Background Pattern -->
  <div 
    class="loader-pattern" 
    *ngIf="showPattern"
    [class.pattern-dots]="pattern === 'dots'"
    [class.pattern-lines]="pattern === 'lines'"
    [class.pattern-grid]="pattern === 'grid'"
  ></div>
</div>

<!-- Accessibility Announcements -->
<div class="sr-only" aria-live="assertive" aria-atomic="true">
  <span *ngIf="srAnnouncement">{{ srAnnouncement }}</span>
</div>
