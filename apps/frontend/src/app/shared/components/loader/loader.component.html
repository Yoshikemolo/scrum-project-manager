<!-- Loader Component Template -->
<div 
  class="loader-overlay" 
  [class.fullscreen]="fullscreen"
  [class.inline]="!fullscreen"
  [class.backdrop-blur]="backdropBlur"
  [@fadeIn]="animationState"
  [attr.role]="'status'"
  [attr.aria-live]="'polite'"
  [attr.aria-busy]="'true'"
  [attr.aria-label]="message || ('loader.defaultMessage' | translate)"
>
  <!-- Backdrop (only for fullscreen) -->
  <div 
    class="loader-backdrop" 
    *ngIf="fullscreen"
    (click)="onBackdropClick()"
    [class.clickable]="dismissible"
  ></div>

  <!-- Main Loader Container -->
  <div 
    class="loader-container"
    [class.elevated]="fullscreen"
    [class.compact]="size === 'small'"
    [class.expanded]="size === 'large'"
  >
    <!-- Spinner Types -->
    
    <!-- Circular Spinner -->
    <div class="spinner-wrapper" *ngIf="type === 'circular'">
      <mat-progress-spinner
        [mode]="mode"
        [diameter]="spinnerSize"
        [strokeWidth]="strokeWidth"
        [value]="value"
        [color]="color"
        [attr.aria-valuemin]="0"
        [attr.aria-valuemax]="100"
        [attr.aria-valuenow]="mode === 'determinate' ? value : null"
      ></mat-progress-spinner>
      
      <!-- Progress Percentage (for determinate mode) -->
      <div class="progress-text" *ngIf="mode === 'determinate' && showProgress">
        {{ value }}%
      </div>
    </div>

    <!-- Linear Progress Bar -->
    <div class="progress-wrapper" *ngIf="type === 'linear'">
      <mat-progress-bar
        [mode]="mode"
        [value]="value"
        [bufferValue]="bufferValue"
        [color]="color"
        [attr.aria-valuemin]="0"
        [attr.aria-valuemax]="100"
        [attr.aria-valuenow]="mode === 'determinate' ? value : null"
      ></mat-progress-bar>
    </div>

    <!-- Skeleton Loader -->
    <div class="skeleton-wrapper" *ngIf="type === 'skeleton'">
      <div class="skeleton-item" *ngFor="let item of skeletonItems; trackBy: trackByIndex">
        <div class="skeleton-line" [style.width.%]="item.width" [@pulse]></div>
      </div>
    </div>

    <!-- Dots Loader -->
    <div class="dots-wrapper" *ngIf="type === 'dots'">
      <span class="dot" *ngFor="let dot of [1,2,3,4]; trackBy: trackByIndex" [@bounce]></span>
    </div>

    <!-- Pulse Loader -->
    <div class="pulse-wrapper" *ngIf="type === 'pulse'">
      <div class="pulse-ring" [@pulseRing]></div>
      <div class="pulse-ring" [@pulseRing]></div>
      <div class="pulse-ring" [@pulseRing]></div>
    </div>

    <!-- Custom Icon Loader -->
    <div class="icon-wrapper" *ngIf="type === 'icon' && customIcon">
      <mat-icon 
        class="loading-icon" 
        [@rotate]
        [svgIcon]="customIcon.includes('/') ? customIcon : null"
      >
        {{ !customIcon.includes('/') ? customIcon : '' }}
      </mat-icon>
    </div>

    <!-- Loading Message -->
    <div 
      class="loader-message" 
      *ngIf="message"
      [class.message-above]="messagePosition === 'above'"
      [class.message-below]="messagePosition === 'below'"
    >
      <span class="message-text">{{ message | translate }}</span>
      
      <!-- Sub-message -->
      <span class="message-subtext" *ngIf="subMessage">
        {{ subMessage | translate }}
      </span>
    </div>

    <!-- Action Buttons (optional) -->
    <div class="loader-actions" *ngIf="showActions">
      <button 
        mat-button 
        color="primary"
        (click)="onCancel()"
        *ngIf="cancellable"
        [attr.aria-label]="'loader.cancel' | translate"
      >
        <mat-icon>close</mat-icon>
        {{ 'loader.cancel' | translate }}
      </button>
      
      <button 
        mat-button 
        (click)="onRetry()"
        *ngIf="retryable"
        [attr.aria-label]="'loader.retry' | translate"
      >
        <mat-icon>refresh</mat-icon>
        {{ 'loader.retry' | translate }}
      </button>
    </div>

    <!-- Estimated Time -->
    <div class="estimated-time" *ngIf="showEstimatedTime && estimatedTime > 0">
      <mat-icon class="time-icon">schedule</mat-icon>
      <span class="time-text">
        {{ 'loader.estimatedTime' | translate: {time: formatTime(estimatedTime)} }}
      </span>
    </div>

    <!-- Steps Progress (for multi-step operations) -->
    <div class="steps-progress" *ngIf="steps && steps.length > 0">
      <div class="step-indicator">
        {{ 'loader.step' | translate: {current: currentStep + 1, total: steps.length} }}
      </div>
      <div class="steps-list">
        <div 
          class="step-item" 
          *ngFor="let step of steps; let i = index; trackBy: trackByIndex"
          [class.completed]="i < currentStep"
          [class.active]="i === currentStep"
          [class.pending]="i > currentStep"
        >
          <mat-icon class="step-icon">
            {{ i < currentStep ? 'check_circle' : (i === currentStep ? 'radio_button_checked' : 'radio_button_unchecked') }}
          </mat-icon>
          <span class="step-label">{{ step.label | translate }}</span>
          <span class="step-status" *ngIf="i === currentStep && step.status">
            ({{ step.status | translate }})
          </span>
        </div>
      </div>
    </div>
  </div>

  <!-- Accessibility Announcements -->
  <div class="sr-only" aria-live="assertive" aria-atomic="true">
    <span *ngIf="mode === 'determinate'">
      {{ 'loader.progressUpdate' | translate: {value: value} }}
    </span>
    <span *ngIf="currentStep !== undefined && steps">
      {{ 'loader.stepUpdate' | translate: {step: steps[currentStep]?.label} }}
    </span>
  </div>
</div>
