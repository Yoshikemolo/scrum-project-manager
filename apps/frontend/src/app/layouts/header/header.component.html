<mat-toolbar class="header-toolbar" [class.scrolled]="isScrolled()" @slideDown>
  <div class="header-container">
    <!-- Logo and Brand -->
    <div class="header-brand">
      <button 
        mat-icon-button 
        class="menu-toggle"
        (click)="toggleMobileMenu()"
        [attr.aria-label]="'Toggle menu'"
        [attr.aria-expanded]="isMobileMenuOpen()"
      >
        <mat-icon>{{ isMobileMenuOpen() ? 'close' : 'menu' }}</mat-icon>
      </button>
      
      <a routerLink="/" class="brand-link">
        <img src="assets/logo.svg" alt="SCRUM PM" class="brand-logo" />
        <span class="brand-text">SCRUM PM</span>
      </a>
    </div>

    <!-- Navigation (Desktop) -->
    <nav class="header-nav" [attr.aria-label]="'Main navigation'">
      <a 
        *ngFor="let item of navigationItems"
        [routerLink]="item.route"
        routerLinkActive="active"
        class="nav-link"
        matRipple
        [matTooltip]="item.label"
        matTooltipPosition="below"
      >
        <mat-icon class="nav-icon">{{ item.icon }}</mat-icon>
        <span class="nav-text">{{ item.label }}</span>
      </a>
    </nav>

    <!-- Actions -->
    <div class="header-actions">
      <!-- Search -->
      <div class="search-container" [class.focused]="showSearchResults()">
        <mat-form-field appearance="outline" class="search-field">
          <mat-icon matPrefix>search</mat-icon>
          <input 
            #searchInput
            matInput
            type="text"
            placeholder="Search (Ctrl+K)"
            [formControl]="searchControl"
            autocomplete="off"
            [attr.aria-label]="'Global search'"
            [attr.aria-expanded]="showSearchResults()"
            (focus)="showSearchResults.set(true)"
            (blur)="onSearchBlur()"
          />
          <button 
            *ngIf="searchControl.value"
            mat-icon-button 
            matSuffix
            (click)="clearSearch()"
            [attr.aria-label]="'Clear search'"
          >
            <mat-icon>close</mat-icon>
          </button>
          <mat-progress-spinner 
            *ngIf="isSearching()"
            matSuffix
            diameter="20"
            mode="indeterminate"
          ></mat-progress-spinner>
        </mat-form-field>

        <!-- Search Results Dropdown -->
        <div class="search-results" *ngIf="showSearchResults()" @fadeIn>
          <div class="search-results-content">
            <div *ngIf="isSearching()" class="search-loading">
              <mat-progress-spinner diameter="30" mode="indeterminate"></mat-progress-spinner>
              <span>Searching...</span>
            </div>

            <div *ngIf="!isSearching() && searchResults().length === 0 && searchControl.value" class="no-results">
              <mat-icon>search_off</mat-icon>
              <span>No results found for "{{ searchControl.value }}"</span>
            </div>

            <div *ngIf="!isSearching() && searchResults().length > 0" class="results-list">
              <button 
                *ngFor="let result of searchResults()" 
                class="search-result-item"
                (click)="onSearchResultClick(result)"
                matRipple
              >
                <mat-icon class="result-icon">{{ result.icon }}</mat-icon>
                <div class="result-content">
                  <span class="result-title">{{ result.title }}</span>
                  <span class="result-description">{{ result.description }}</span>
                </div>
                <span class="result-type">{{ result.type }}</span>
              </button>
            </div>

            <div class="search-shortcuts">
              <span><kbd>↑↓</kbd> Navigate</span>
              <span><kbd>Enter</kbd> Select</span>
              <span><kbd>Esc</kbd> Close</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Theme Toggle -->
      <button 
        mat-icon-button
        (click)="toggleTheme()"
        [matTooltip]="isDarkTheme() ? 'Light mode' : 'Dark mode'"
        [attr.aria-label]="'Toggle theme'"
      >
        <mat-icon>{{ isDarkTheme() ? 'light_mode' : 'dark_mode' }}</mat-icon>
      </button>

      <!-- Notifications -->
      <button 
        mat-icon-button
        [matMenuTriggerFor]="notificationsMenu"
        [matBadge]="unreadNotifications()"
        [matBadgeHidden]="unreadNotifications() === 0"
        matBadgeColor="warn"
        matBadgeSize="small"
        [matTooltip]="'Notifications'"
        [attr.aria-label]="'Notifications, ' + unreadNotifications() + ' unread'"
        [@badgePulse]="badgeAnimation()"
      >
        <mat-icon>notifications</mat-icon>
      </button>

      <!-- Connection Status -->
      <div class="connection-status" [matTooltip]="getConnectionStatusTooltip()">
        <span 
          class="status-indicator" 
          [class.connected]="connectionStatus() === 'connected'"
          [class.connecting]="connectionStatus() === 'connecting'"
          [class.disconnected]="connectionStatus() === 'disconnected'"
        ></span>
      </div>

      <!-- User Menu -->
      <button 
        mat-button
        class="user-menu-button"
        [matMenuTriggerFor]="userMenu"
        [attr.aria-label]="'User menu'"
      >
        <div class="user-avatar" *ngIf="getUserAvatar(); else avatarPlaceholder">
          <img [src]="getUserAvatar()" [alt]="user()?.firstName + ' ' + user()?.lastName" />
        </div>
        <ng-template #avatarPlaceholder>
          <div class="user-avatar-placeholder">
            {{ getUserInitials() }}
          </div>
        </ng-template>
        <span class="user-name">{{ user()?.firstName }} {{ user()?.lastName }}</span>
        <mat-icon class="dropdown-icon">arrow_drop_down</mat-icon>
      </button>
    </div>
  </div>

  <!-- Mobile Menu -->
  <div class="mobile-menu" *ngIf="isMobileMenuOpen()" @slideDown>
    <nav class="mobile-nav">
      <a 
        *ngFor="let item of navigationItems"
        [routerLink]="item.route"
        routerLinkActive="active"
        class="mobile-nav-link"
        (click)="closeMobileMenu()"
      >
        <mat-icon>{{ item.icon }}</mat-icon>
        <span>{{ item.label }}</span>
      </a>
    </nav>
  </div>
</mat-toolbar>

<!-- User Menu Dropdown -->
<mat-menu #userMenu="matMenu" class="user-dropdown-menu">
  <div class="user-info">
    <div class="user-avatar-large" *ngIf="getUserAvatar(); else largeAvatarPlaceholder">
      <img [src]="getUserAvatar()" [alt]="user()?.firstName + ' ' + user()?.lastName" />
    </div>
    <ng-template #largeAvatarPlaceholder>
      <div class="user-avatar-placeholder-large">
        {{ getUserInitials() }}
      </div>
    </ng-template>
    <div class="user-details">
      <span class="user-fullname">{{ user()?.firstName }} {{ user()?.lastName }}</span>
      <span class="user-email">{{ user()?.email }}</span>
      <span class="user-role">{{ user()?.role }}</span>
    </div>
  </div>
  
  <mat-divider></mat-divider>
  
  <button 
    *ngFor="let item of userMenuItems"
    mat-menu-item
    (click)="!item.divider && handleUserMenuAction(item.action)"
    [disabled]="item.divider"
    [class.danger]="item.danger"
  >
    <ng-container *ngIf="!item.divider">
      <mat-icon>{{ item.icon }}</mat-icon>
      <span>{{ item.label }}</span>
      <span 
        *ngIf="item.badge && unreadNotifications() > 0" 
        class="menu-badge"
      >
        {{ unreadNotifications() }}
      </span>
    </ng-container>
    <mat-divider *ngIf="item.divider"></mat-divider>
  </button>
</mat-menu>

<!-- Notifications Menu -->
<mat-menu #notificationsMenu="matMenu" class="notifications-menu">
  <div class="notifications-header">
    <h3>Notifications</h3>
    <button mat-icon-button [matTooltip]="'Mark all as read'">
      <mat-icon>done_all</mat-icon>
    </button>
  </div>
  
  <mat-divider></mat-divider>
  
  <div class="notifications-content">
    <div class="no-notifications" *ngIf="unreadNotifications() === 0">
      <mat-icon>notifications_none</mat-icon>
      <span>No new notifications</span>
    </div>
    
    <!-- Notification items would be rendered here -->
  </div>
  
  <mat-divider></mat-divider>
  
  <div class="notifications-footer">
    <a routerLink="/notifications" class="view-all-link">
      View all notifications
      <mat-icon>arrow_forward</mat-icon>
    </a>
  </div>
</mat-menu>