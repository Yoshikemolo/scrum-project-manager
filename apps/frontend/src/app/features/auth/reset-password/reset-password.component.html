<div class="reset-password-container" @fadeInOut>
  <mat-card class="reset-password-card">
    <mat-card-header>
      <div class="reset-password-header">
        <div class="icon-container">
          <mat-icon class="key-icon">vpn_key</mat-icon>
        </div>
        <h1 class="title">Reset Your Password</h1>
        <p class="subtitle">Create a new strong password for your account</p>
      </div>
    </mat-card-header>

    <mat-card-content>
      <!-- Loading State -->
      <div class="loading-state" *ngIf="isLoading() && tokenValid() === null" @fadeInOut>
        <mat-spinner diameter="60"></mat-spinner>
        <p>Validating reset link...</p>
      </div>

      <!-- Token Expired State -->
      <div class="expired-state" *ngIf="tokenExpired() && !passwordReset()" @fadeInOut>
        <div class="expired-icon">
          <mat-icon>link_off</mat-icon>
        </div>
        <h2 class="expired-title">Link Expired</h2>
        <p class="expired-message">
          This password reset link has expired or is invalid.
          Password reset links are valid for 1 hour for security reasons.
        </p>
        <div class="expired-actions">
          <button mat-raised-button color="primary" (click)="requestNewLink()" class="full-width">
            <mat-icon>refresh</mat-icon>
            Request New Reset Link
          </button>
          <button mat-stroked-button routerLink="/auth/login" class="full-width">
            <mat-icon>arrow_back</mat-icon>
            Back to Login
          </button>
        </div>
      </div>

      <!-- Success State -->
      <div class="success-state" *ngIf="passwordReset()" @fadeInOut>
        <div class="success-icon" @checkmark>
          <mat-icon>check_circle</mat-icon>
        </div>
        <h2 class="success-title">Password Reset Successful!</h2>
        <p class="success-message">
          Your password has been successfully reset.
          You can now login with your new password.
        </p>
        <div class="redirect-info">
          <mat-icon>schedule</mat-icon>
          <span>Redirecting to login in {{ redirectCountdown() }} seconds...</span>
        </div>
        <button mat-raised-button color="primary" routerLink="/auth/login" class="full-width">
          <mat-icon>login</mat-icon>
          Go to Login Now
        </button>
      </div>

      <!-- Reset Form State -->
      <form 
        [formGroup]="resetPasswordForm" 
        (ngSubmit)="onSubmit()" 
        class="reset-password-form"
        *ngIf="tokenValid() && !passwordReset() && !tokenExpired()"
        @fadeInOut
      >
        <!-- Password Field -->
        <mat-form-field appearance="outline" class="full-width">
          <mat-label>New Password</mat-label>
          <input
            matInput
            [type]="hidePassword() ? 'password' : 'text'"
            formControlName="password"
            placeholder="Enter your new password"
            autocomplete="new-password"
            [attr.aria-label]="'New password input'"
            [attr.aria-invalid]="hasError('password')"
            [attr.aria-describedby]="'password-requirements'"
          />
          <mat-icon matPrefix>lock</mat-icon>
          <button
            mat-icon-button
            matSuffix
            type="button"
            (click)="togglePasswordVisibility()"
            [attr.aria-label]="hidePassword() ? 'Show password' : 'Hide password'"
          >
            <mat-icon>{{ hidePassword() ? 'visibility' : 'visibility_off' }}</mat-icon>
          </button>
          <mat-error *ngIf="hasError('password')">
            {{ getErrorMessage('password') }}
          </mat-error>
        </mat-form-field>

        <!-- Password Strength Indicator -->
        <div class="password-strength" *ngIf="resetPasswordForm.get('password')?.value">
          <div class="strength-header">
            <span class="strength-label">Password Strength: {{ getPasswordStrengthLabel() }}</span>
            <span class="strength-percentage">{{ passwordStrength() }}%</span>
          </div>
          <mat-progress-bar 
            mode="determinate" 
            [value]="passwordStrength()" 
            [color]="getPasswordStrengthColor()"
          ></mat-progress-bar>
        </div>

        <!-- Password Requirements -->
        <div class="password-requirements" id="password-requirements">
          <h3 class="requirements-title">Password Requirements:</h3>
          <mat-list dense>
            <mat-list-item *ngFor="let req of passwordRequirements">
              <mat-icon matListItemIcon [class.met]="req.met">
                {{ req.met ? 'check_circle' : 'radio_button_unchecked' }}
              </mat-icon>
              <span matListItemTitle [class.met]="req.met">
                {{ req.label }}
              </span>
            </mat-list-item>
          </mat-list>
        </div>

        <!-- Confirm Password Field -->
        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Confirm New Password</mat-label>
          <input
            matInput
            [type]="hideConfirmPassword() ? 'password' : 'text'"
            formControlName="confirmPassword"
            placeholder="Re-enter your new password"
            autocomplete="new-password"
            [attr.aria-label]="'Confirm password input'"
            [attr.aria-invalid]="hasError('confirmPassword')"
          />
          <mat-icon matPrefix>lock_outline</mat-icon>
          <button
            mat-icon-button
            matSuffix
            type="button"
            (click)="toggleConfirmPasswordVisibility()"
            [attr.aria-label]="hideConfirmPassword() ? 'Show password' : 'Hide password'"
          >
            <mat-icon>{{ hideConfirmPassword() ? 'visibility' : 'visibility_off' }}</mat-icon>
          </button>
          <mat-error *ngIf="hasError('confirmPassword')">
            {{ getErrorMessage('confirmPassword') }}
          </mat-error>
        </mat-form-field>

        <!-- Submit Button -->
        <button
          mat-raised-button
          color="primary"
          type="submit"
          class="full-width submit-button"
          [disabled]="isSubmitDisabled()"
          [attr.aria-busy]="isLoading()"
        >
          <mat-spinner
            *ngIf="isLoading()"
            diameter="20"
            class="button-spinner"
          ></mat-spinner>
          <span *ngIf="!isLoading()">
            <mat-icon>lock_reset</mat-icon>
            Reset Password
          </span>
          <span *ngIf="isLoading()">Resetting...</span>
        </button>

        <!-- Cancel Link -->
        <div class="form-footer">
          <a routerLink="/auth/login" class="cancel-link">
            <mat-icon>close</mat-icon>
            Cancel
          </a>
        </div>
      </form>
    </mat-card-content>

    <mat-card-footer *ngIf="!passwordReset() && !tokenExpired()">
      <div class="footer-info">
        <div class="info-item">
          <mat-icon>info</mat-icon>
          <span>Choose a strong password that you haven't used before</span>
        </div>
        <div class="info-item">
          <mat-icon>security</mat-icon>
          <span>Your password is encrypted and stored securely</span>
        </div>
      </div>
    </mat-card-footer>
  </mat-card>

  <!-- Background decoration -->
  <div class="background-decoration">
    <div class="hex hex-1"></div>
    <div class="hex hex-2"></div>
    <div class="hex hex-3"></div>
    <div class="hex hex-4"></div>
  </div>
</div>